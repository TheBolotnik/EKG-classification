# EKG Classification (PTB‑XL, XGBoost)

Классический ML‑проект по **многоклассовой классификации ЭКГ** с использованием набора данных **PTB‑XL** и признаков, извлекаемых из **12 отведений**.  
Проект ориентирован на «user‑friendly» опыт: **готовая предобученная модель** уже входит в репозиторий, инференс доступен «из коробки», есть **GUI (Tkinter)**.

---

## Что делает проект
- Извлекает базовые статистические признаки из 12‑канальных сигналов ЭКГ (mean, std, min, max, skew, kurtosis, energy на отведение).
- Обучает/использует **XGBoost** для классификации суперклассов PTB‑XL: `NORM`, `MI`, `STTC`, `CD`, `HYP`.
- Возвращает диагноз **на английском и на русском** (встроенный словарь переводов).

Пример вывода инференса:
```
Predicted: STTC — Изменения сегмента ST/Т (неспецифические)
Probabilities:
  CD — Нарушения проводимости: 0.015
  HYP — Гипертрофия:            0.004
  MI  — Инфаркт миокарда:       0.018
  NORM — Норма:                 0.053
  STTC — Изменения ST/Т:        0.910
```

---

## Что уже включено
- **`models/xgb.pkl`** — **предобученная** модель (bundle: сам классификатор, LabelEncoder, имена признаков, метрики).
- **`scripts/app_gui.py`** — минимальный **GUI** (Tkinter) для инференса одного файла без консоли.
- **`scripts/predict.py`** — CLI‑утилита для инференса одного файла (с JSON/вероятностями).
- **`scripts/setup_and_train.py`** — авто‑загрузка PTB‑XL + (опц.) обучение.
- **`scripts/finetune.py`** — дообучение (добавление деревьев или полное переобучение).
- **`main.py`** — «однокнопочный» старт: если путь к PTB‑XL не найден, **автоматически** скачает CSV и подмножество WFDB и обучит модель; затем выполнит инференс.

> **Важно.** Для демонстрации в репозитории добавлены примерные WFDB‑файлы (`.hea/.dat`) — достаточно для проверки инференса. Полный PTB‑XL весит много; его можно автоматически подтянуть при первом запуске.

---

## Установка
```bash
git clone https://github.com/TheBolotnik/EKG-classification.git
cd EKG-classification

# (рекомендуется) создать виртуальное окружение
python -m venv venv
# Windows
venv\Scripts\activate
# Linux/macOS
# source venv/bin/activate

pip install -r requirements.txt
```

---

## Быстрый старт (предобученная модель)
Запустите главный скрипт — он **сам** найдёт (или подготовит) путь к данным и выполнит инференс на тестовой записи:
```bash
python main.py
```
Логика `main.py`:
1. Ищет `base_path` к PTB‑XL (из `ekg_config.yaml` / переменной окружения / типичных путей).
2. Если путь **не найден** — **автоматически** запускает `scripts/setup_and_train.py --download subset --subset-size 500`, скачивает CSV и ~500 сигналов, записывает путь.
3. Если **модели нет** — обучает и сохраняет в `models/xgb.pkl`.
4. Выполняет инференс на первой найденной записи.  
   Выводит **код класса и его русский перевод**.

> По умолчанию инференс принудительно выполняется на **CPU** (чтобы исключить предупреждения XGBoost о несовпадении устройств).

---

## Графический интерфейс (GUI, Tkinter)
Запуск:
```bash
python scripts/app_gui.py
```
В окне:
1. Укажите путь к модели (по умолчанию — `models/xgb.pkl`).
2. Нажмите «Выбрать .hea…» и укажите заголовочный файл записи WFDB (или путь без расширения).
3. (Опционально) укажите количество отведений (по умолчанию — **все 12**).
4. Нажмите «Предсказать».

GUI покажет:
- путь к записи,
- предсказанный класс **на английском и русском**,
- число признаков,
- (если поддерживается) вероятности по всем классам с русскими подписями.

---

## CLI‑инференс для одного файла
```bash
python scripts/predict.py --input "records100/00000/00001_lr" --proba
# или абсолютный путь к .hea/.dat
python scripts/predict.py --input "D:\datasets\ptb-xl\1.0.1\records100\00000\00001_lr.hea" --proba
```
Опции:
- `--proba` — печатать вероятности;
- `--json` — вывести результат в JSON.

Скрипт:
- сам резолвит путь (понимает записи без/с расширением, относительные/абсолютные пути),
- подтягивает перевод на русский,
- корректно выравнивает признаки с порядком обучения.

---

## Дообучение модели (COntinuous training)

### Вариант A — «добавить деревья» к существующей модели (быстро)
```bash
python scripts/finetune.py --pretrained models/xgb.pkl --mode add_trees --extra_estimators 150
```
- повторно извлекает признаки из имеющихся данных PTB‑XL;
- обучает дополнительные деревья и **перезаписывает** `models/xgb.pkl`.

### Вариант B — полное переобучение на новых данных
```bash
python scripts/finetune.py --pretrained models/xgb.pkl --mode retrain
```
- заново извлекает признаки;
- балансирует классы;
- обучает XGBoost «с нуля» и сохраняет обновлённую модель.

> Путь к PTB‑XL берётся из `ekg_config.yaml`. Можно указать явно: `--base-path /path/to/ptb-xl/1.0.1`.

### Замечания по устройству (CPU/GPU)
- В коде обучения (XGBoost 2.x) для **GPU** используется: `tree_method="hist", device="cuda"`.  
  Для **CPU** просто уберите эти параметры.
- Инференс по умолчанию идёт на **CPU** (`model.set_params(device="cpu")`), чтобы избежать предупреждений о несовпадении устройств.

---

## Структура проекта
```
ECG-classification/
├── data/
│   └── ptb-xl/1.0.1/              # создаётся автоматически (CSV + WFDB subset при первом запуске)
├── models/
│   └── xgb.pkl                    # предобученная модель (bundle)
├── scripts/
│   ├── app_gui.py                 # GUI-интерфейс
│   ├── predict.py                 # CLI-инференс одного файла
│   ├── setup_and_train.py         # авто-загрузка PTB-XL + (опц.) обучение
│   └── finetune.py                # дообучение / переобучение
├── src/
│   ├── config.py                  # поиск/сохранение base_path PTB‑XL
│   ├── dataio.py                  # чтение CSV, проверки существования WFDB
│   ├── features.py                # извлечение признаков из сигналов
│   ├── labels.py                  # словарь переводов классов на русский
│   ├── model.py                   # обучение/сохранение/загрузка модели
│   └── __init__.py
├── requirements.txt
└── main.py                        # «однокнопочный» старт
```

---

## Данные и права
- **Набор данных:** PTB‑XL (PhysioNet).  
  Wagner, P., et al. (2020). *Scientific Data, 7(1)*.  
  Страница датасета: <https://physionet.org/content/ptb-xl/1.0.1/>
- **Лицензия данных:** **ODC‑BY 1.0** (PhysioNet).  
- **Исходный код:** MIT License.
